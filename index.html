<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>매공매 커뮤니티 매일공부매니저</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 860px; margin: 32px auto; padding: 0 16px; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; }
    textarea { min-height: 120px; resize: vertical; }
    button { padding: 10px 14px; border: 1px solid #ddd; background: #fff; border-radius: 10px; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .card { border: 1px solid #eee; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .muted { color: #666; font-size: 14px; }
    .post-title { font-weight: 700; margin: 0 0 6px; }
    hr { border: none; border-top: 1px solid #eee; margin: 18px 0; }
    .small { font-size: 13px; }
  </style>
</head>
<body>
  <h1>매공매 익명 커뮤니티</h1>

  <div class="card">
    <div class="row">
      <div>내 닉네임: <b id="nickname">...</b></div>
      <button id="btnChangeNick">닉네임 변경</button>
      <span class="muted small" id="status">초기화 중...</span>
    </div>
  </div>


  <hr />

  <div class="row" style="justify-content: space-between;">
    <h2 style="margin:0;">글 목록</h2>
    <div class="row"></div>
        <button id="btnNewPost" disabled>글 작성하기</button>
        <button id="btnRefresh" disabled>새로고침</button>
  </div>
  <div id="postList" class="muted" style="margin-top:10px;">불러오는 중...</div>

  <!-- 상세 모달 -->
    <div id="modalBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); padding:24px; overflow:auto;">
    <div style="max-width:860px; margin:40px auto; background:#fff; border-radius:16px; padding:16px; border:1px solid #eee;">
        <div class="row" style="justify-content: space-between; align-items:flex-start;">
        <div style="flex:1;">
            <div id="modalTitle" style="font-weight:800; font-size:20px; margin-bottom:6px;"></div>
            <div id="modalMeta" class="muted small"></div>
        </div>
        <div class="row">
            <button id="modalClose">닫기</button>
        </div>
        </div>
        <hr />
        <div id="modalContent" style="white-space:pre-wrap; line-height:1.55;"></div>

        <hr />

        <h3 style="margin:0 0 10px;">댓글</h3>

        <div class="row" style="gap:8px;">
            <input id="commentInput" placeholder="댓글 (1~1000자)" maxlength="1000" />
            <button id="btnComment">등록</button>
        </div>

        <div id="commentList" class="muted" style="margin-top:10px;">댓글 불러오는 중...</div>


    </div>
    </div>


    
    <!-- 글 작성 모달 -->
    <div id="writeBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); padding:24px; overflow:auto;">
        <div style="max-width:860px; margin:40px auto; background:#fff; border-radius:16px; padding:16px; border:1px solid #eee;">
            <div class="row" style="justify-content: space-between; align-items:flex-start;">
                <div style="font-weight:800; font-size:20px;">새 글 작성</div>
                <button id="writeClose">닫기</button>
            </div>
            <hr />

            <input id="title" placeholder="제목 (1~80자)" maxlength="80" />
            <div style="height:10px;"></div>
            <textarea id="content" placeholder="내용 (1~5000자)" maxlength="5000"></textarea>

            <div class="row" style="justify-content:flex-end; margin-top:10px;">
                <button id="btnWrite" disabled>작성</button>
            </div>

            <div class="muted small" style="margin-top:8px;">
                ※ 작성은 익명으로 올라가며, 작성자만 삭제할 수 있어요.
            </div>
        </div>
    </div>


  <script type="module">
    // ===== 1) Firebase SDK import (모듈 방식) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc,
      collection, addDoc,
      query, where, orderBy, limit, getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== 2) 너의 Firebase 설정값 넣기 =====
    // Firebase Console > Project settings > General > Your apps (Web) > SDK setup and configuration
    const firebaseConfig = {
      apiKey: "AIzaSyByA67hdXTuPjSkNISijCMu9BAqd2LPDmU",
      authDomain: "mgmcommunity-19ac2.firebaseapp.com",
      projectId: "mgmcommunity-19ac2",
      storageBucket: "mgmcommunity-19ac2.firebasestorage.app",
      messagingSenderId: "556812418434",
      appId: "1:556812418434:web:7c46c05b546b9c2f5aa39b",
    };

    // ===== 3) 앱 초기화 =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== 4) DOM =====
    const $nickname = document.getElementById("nickname");
    const $status = document.getElementById("status");
    const $btnChangeNick = document.getElementById("btnChangeNick");
    const $title = document.getElementById("title");
    const $content = document.getElementById("content");
    const $btnWrite = document.getElementById("btnWrite");
    const $btnRefresh = document.getElementById("btnRefresh");
    const $postList = document.getElementById("postList");

    const $modalBackdrop = document.getElementById("modalBackdrop");
    const $modalClose = document.getElementById("modalClose");
    const $modalTitle = document.getElementById("modalTitle");
    const $modalMeta = document.getElementById("modalMeta");
    const $modalContent = document.getElementById("modalContent");


    const $commentInput = document.getElementById("commentInput");
    const $btnComment = document.getElementById("btnComment");
    const $commentList = document.getElementById("commentList");

    const $btnNewPost = document.getElementById("btnNewPost");
    const $writeBackdrop = document.getElementById("writeBackdrop");
    const $writeClose = document.getElementById("writeClose");


    let currentPostId = null; // 지금 모달로 보고 있는 글 id



    let currentUid = null;
    let currentNickname = null;

    function makeDefaultNickname() {
      const n = Math.floor(1000 + Math.random() * 9000);
      return `익명${n}`;
    }

    function setStatus(msg) {
      $status.textContent = msg;
    }

    function escapeHtml(str) {
      return str
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function canWriteNow() {
      const t = $title.value.trim();
      const c = $content.value.trim();
      return !!currentUid && t.length >= 1 && t.length <= 80 && c.length >= 1 && c.length <= 5000;
    }

    function updateButtons() {
      const ready = !!currentUid;
      $btnRefresh.disabled = !ready;
      $btnNewPost.disabled = !ready;
      $btnWrite.disabled = !canWriteNow();
    }

    function openWriteModal() {
        $writeBackdrop.style.display = "block";
        $title.focus();
    }
    function closeWriteModal() {
        $writeBackdrop.style.display = "none";
        $title.value = "";
        $content.value = "";
        updateButtons();
    }

    $btnNewPost.addEventListener("click", openWriteModal);
    $writeClose.addEventListener("click", closeWriteModal);
    $writeBackdrop.addEventListener("click", (e) => {
        if (e.target === $writeBackdrop) closeWriteModal();
    });


    // ===== 5) 익명 로그인 + users/{uid} 생성 =====
    async function bootstrap() {
      setStatus("익명 로그인 중...");
      await signInAnonymously(auth);

      onAuthStateChanged(auth, async (user) => {
        if (!user) return;

        currentUid = user.uid;
        setStatus("사용자 정보 확인 중...");

        // users/{uid} 문서 확인/생성
        const userRef = doc(db, "users", currentUid);
        const snap = await getDoc(userRef);

        if (!snap.exists()) {
          const nick = makeDefaultNickname();
          await setDoc(userRef, {
            nickname: nick,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          });
          currentNickname = nick;
        } else {
          currentNickname = snap.data().nickname ?? makeDefaultNickname();
        }

        $nickname.textContent = currentNickname;
        setStatus("준비 완료");
        updateButtons();
        await loadPosts();
      });
    }

    // ===== 6) 닉네임 변경 =====
    $btnChangeNick.addEventListener("click", async () => {
      if (!currentUid) return;

      const input = prompt("새 닉네임 (2~12자):", currentNickname ?? "");
      if (input == null) return;

      const newNick = input.trim();
      if (newNick.length < 2 || newNick.length > 12) {
        alert("닉네임은 2~12자여야 합니다.");
        return;
      }

      try {
        setStatus("닉네임 변경 중...");
        await updateDoc(doc(db, "users", currentUid), {
          nickname: newNick,
          updatedAt: serverTimestamp(),
        });
        currentNickname = newNick;
        $nickname.textContent = currentNickname;
        setStatus("준비 완료");
      } catch (e) {
        console.error(e);
        alert("닉네임 변경 실패. (Rules/권한 확인)");
        setStatus("오류");
      }
    });

    // ===== 7) 글 작성 =====
    async function createPost() {
      const title = $title.value.trim();
      const content = $content.value.trim();
      

      if (!canWriteNow()) return;

      try {
        setStatus("글 작성 중...");
        $btnWrite.disabled = true;

        // 닉네임 최신값을 users에서 다시 읽어 스냅샷 저장(권장)
        const u = await getDoc(doc(db, "users", currentUid));
        const nick = u.data()?.nickname ?? currentNickname ?? "익명????";

        await addDoc(collection(db, "posts"), {
          title,
          content,
          authorUid: currentUid,
          authorNickname: nick,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          isDeleted: false,
          isBlind: false,
          blindReason: "",
        });

        $title.value = "";
        $content.value = "";
        setStatus("작성 완료");
        await loadPosts();
        closeWriteModal();

      } catch (e) {
        console.error(e);
        alert("작성 실패. (Rules/인덱스/네트워크 확인)");
        setStatus("오류");
      } finally {
        setStatus("준비 완료");
        updateButtons();
      }
    }


    $btnWrite.addEventListener("click", createPost);
    $title.addEventListener("input", updateButtons);
    $content.addEventListener("input", updateButtons);



    async function softDeletePost(postId) {
        if (!currentUid) return;

        const ok = confirm("이 글을 삭제할까? (삭제하면 목록에서 사라져)");
        if (!ok) return;

        try {
            setStatus("삭제 중...");
            await updateDoc(doc(db, "posts", postId), {
                isDeleted: true,
                updatedAt: serverTimestamp(),
            });
            setStatus("삭제 완료");
            await loadPosts();
          } catch (e) {
            console.error(e);
            alert("삭제 실패. (작성자만 삭제 가능 / Rules 확인)");
            setStatus("오류");
          } finally {
            setStatus("준비 완료");
          }
        }


    function openModal() {
        $modalBackdrop.style.display = "block";
    }
    function closeModal() {
        $modalBackdrop.style.display = "none";
        $modalTitle.textContent = "";
        $modalMeta.textContent = "";
        $modalContent.textContent = "";
        currentPostId = null;
        $commentInput.value = "";
        $commentList.textContent = "";
        $btnComment.disabled = false;

    }

    $modalClose.addEventListener("click", closeModal);
    $modalBackdrop.addEventListener("click", (e) => {
        if (e.target === $modalBackdrop) closeModal(); // 바깥 클릭 닫기
    });

    async function openPostDetail(postId) {
    try {
        setStatus("상세 불러오는 중...");
        const ref = doc(db, "posts", postId);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
            alert("존재하지 않거나 삭제된 글입니다.");
            setStatus("준비 완료");
            return;
        }

        const p = snap.data();

        // 혹시 모를 방어(일반 유저는 rules로 못 보게 되지만)
        if (p.isDeleted || p.isBlind) {
            alert("존재하지 않거나 삭제된 글입니다.");
            setStatus("준비 완료");
            return;
        }

        $modalTitle.textContent = p.title ?? "(제목 없음)";
        const createdAt = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : "";
        $modalMeta.textContent = `${p.authorNickname ?? "익명"} · ${createdAt}`;
        $modalContent.textContent = p.content ?? "";

        currentPostId = postId;
        openModal();
        await loadComments(postId);

        setStatus("준비 완료");
    } catch (e) {
        console.error(e);
        alert("상세 로드 실패");
        setStatus("오류");
    } finally {
      setStatus("준비 완료");
    }
    }



    function commentColRef(postId) {
        return collection(db, "posts", postId, "comments");
    }

    async function loadComments(postId) {
      try {
        $commentList.textContent = "댓글 불러오는 중...";

        const q = query(
            commentColRef(postId),
            where("isDeleted", "==", false),
            where("isBlind", "==", false),
            orderBy("createdAt", "asc"),
            limit(100)
        );

        const snap = await getDocs(q);

        if (snap.empty) {
            $commentList.innerHTML = `<div class="muted">아직 댓글이 없습니다.</div>`;
            return;
        }

        const html = snap.docs.map(d => {
            const c = d.data();
            const nick = escapeHtml(c.authorNickname ?? "익명");
            const content = escapeHtml(c.content ?? "");
            const createdAt = c.createdAt?.toDate ? c.createdAt.toDate().toLocaleString() : "";
            const isMine = (c.authorUid === currentUid);

            return `
                <div class="card commentCard" data-id="${d.id}" style="padding:10px; margin:10px 0;">
                    <div class="row" style="justify-content: space-between; align-items:flex-start;">
                        <div style="flex:1;">
                            <div class="muted small">${nick} · ${createdAt}</div>
                            <div style="margin-top:6px; white-space:pre-wrap;">${content}</div>
                        </div>
                        ${isMine ? `<button class="btnDeleteComment" data-id="${d.id}">삭제</button>` : ``}
                    </div>
                </div>
            `;
        }).join("");

        $commentList.innerHTML = html;
    } catch (e) {
        console.error(e);
        $commentList.innerHTML = `<div class="muted">댓글 로드 실패 (Rules/인덱스 확인)</div>`;
    }
    }

    async function addComment() {
    if (!currentUid || !currentPostId) return;

    const content = $commentInput.value.trim();
        if (content.length < 1 || content.length > 1000) {
            alert("댓글은 1~1000자");
            return;
        }

    try {
        setStatus("댓글 작성 중...");
        $btnComment.disabled = true;

        // 최신 닉네임 스냅샷
        const u = await getDoc(doc(db, "users", currentUid));
        const nick = u.data()?.nickname ?? currentNickname ?? "익명????";

        await addDoc(commentColRef(currentPostId), {
            content,
            authorUid: currentUid,
            authorNickname: nick,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            isDeleted: false,
            isBlind: false,
        });

        $commentInput.value = "";
        await loadComments(currentPostId);
      } catch (e) {
        console.error(e);
        alert("댓글 작성 실패 (Rules/인덱스/네트워크 확인)");
      } finally {
        $btnComment.disabled = false;
        setStatus("준비 완료");
      }
    }

    async function softDeleteComment(commentId) {
    if (!currentUid || !currentPostId) return;

    const ok = confirm("이 댓글을 삭제할까?");
        if (!ok) return;

        try {
            setStatus("댓글 삭제 중...");
            await updateDoc(doc(db, "posts", currentPostId, "comments", commentId), {
                isDeleted: true,
                updatedAt: serverTimestamp(),
            });
            await loadComments(currentPostId);
        } catch (e) {
            console.error(e);
            alert("댓글 삭제 실패 (작성자만 삭제 가능 / Rules 확인)");
        } finally {
            setStatus("준비 완료");
        }
    }







    // ===== 8) 글 목록 불러오기 =====
    async function loadPosts() {
      if (!currentUid) return;

      try {
        setStatus("목록 불러오는 중...");
        $postList.textContent = "불러오는 중...";

        const q = query(
          collection(db, "posts"),
          where("isDeleted", "==", false),
          where("isBlind", "==", false),
          orderBy("createdAt", "desc"),
          limit(20)
        );

        const snap = await getDocs(q);

        if (snap.empty) {
          $postList.innerHTML = `<div class="muted">아직 글이 없습니다.</div>`;
          setStatus("준비 완료");
          return;
        }

        const html = snap.docs.map(d => {
          const p = d.data();
          const title = escapeHtml(p.title ?? "(제목 없음)");
          const nick = escapeHtml(p.authorNickname ?? "익명");
          const content = escapeHtml((p.content ?? "").slice(0, 120));
          const createdAt = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : "";
          
          const isMine = (p.authorUid === currentUid);

          return `
            <div class="card postCard" data-id="${d.id}" style="cursor:pointer;">
                <div class="row" style="justify-content: space-between; align-items: flex-start;">
                <div style="flex:1;">
                    <div class="post-title">${title}</div>
                    <div class="muted small">${nick} · ${createdAt}</div>
                </div>
                ${isMine ? `<button class="btnDelete" data-id="${d.id}">삭제</button>` : ``}
                </div>

                <div style="margin-top:10px;">${content}${(p.content?.length ?? 0) > 120 ? "…" : ""}</div>
            </div>
          `;
        }).join("");

        $postList.innerHTML = html;

        setStatus("준비 완료");
      } catch (e) {
        console.error(e);
        $postList.innerHTML = `<div class="muted">목록 로드 실패. (Rules/인덱스 확인)</div>`;
        setStatus("오류");

        // 인덱스 필요하면 콘솔에 에러 메시지와 링크가 뜸
      }
    }

    // ✅ 글 목록 이벤트 위임 (한 번만)
    $postList.addEventListener("click", (e) => {
        const del = e.target.closest(".btnDelete");
        if (del) {
            e.stopPropagation();
            softDeletePost(del.dataset.id);
            return;
        }
        const card = e.target.closest(".postCard");
        if (card) openPostDetail(card.dataset.id);
    });


    // ✅ 댓글 이벤트: 한 번만 등록 (loadPosts 밖!)
    $btnComment.addEventListener("click", addComment);
    $commentInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") addComment();
    });

    $commentList.addEventListener("click", (e) => {
        const btn = e.target.closest(".btnDeleteComment");
        if (btn) {
            softDeleteComment(btn.dataset.id);
        }
    });


    $btnRefresh.addEventListener("click", loadPosts);

    // ===== 시작 =====
    bootstrap();
  </script>
</body>
</html>
