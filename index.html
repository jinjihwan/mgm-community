<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë§¤ê³µë§¤ ì»¤ë®¤ë‹ˆí‹° ë§¤ì¼ê³µë¶€ë§¤ë‹ˆì €</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 860px; margin: 32px auto; padding: 0 16px; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; }
    textarea { min-height: 180px; resize: vertical; }
    button { padding: 10px 14px; border: 1px solid #ddd; background: #fff; border-radius: 10px; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .card { border: 1px solid #eee; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .muted { color: #666; font-size: 14px; }
    .post-title { font-weight: 700; margin: 0 0 6px; }
    hr { border: none; border-top: 1px solid #eee; margin: 18px 0; }
    .small { font-size: 13px; }

    /* ===== ë‹¤í¬ëª¨ë“œ ===== */
    body.dark {
        background: #121212;
        color: #eaeaea;
    }

    body.dark .card {
        background: #1e1e1e;
        border-color: #333;
    }

    body.dark input,
    body.dark textarea {
        background: #1a1a1a;
        color: #eaeaea;
        border-color: #444;
    }

    body.dark button {
        background: #1a1a1a;
        color: #eaeaea;
        border-color: #444;
    }

    body.dark button:hover {
        background: #222;
    }

    body.dark .muted {
        color: #aaa;
    }

    body.dark hr {
        border-top-color: #333;
    }

    /* ëª¨ë‹¬ ë°°ê²½ */
    body.dark #modalBackdrop > div,
    body.dark #writeBackdrop > div {
        background: #1e1e1e;
        border-color: #333;
    }


    * {
        box-sizing: border-box;
    }



  </style>
</head>
<body>
  <h1>ë§¤ê³µë§¤ ìµëª… ì»¤ë®¤ë‹ˆí‹°</h1>

    <div class="row" style="justify-content: space-between;">
        <div class="row">
            <div>ë‚´ ë‹‰ë„¤ì„: <b id="nickname">...</b></div>
            <button id="btnChangeNick">ë‹‰ë„¤ì„ ë³€ê²½</button>
        </div>
        <div class="row">
            <button id="btnTheme">ğŸŒ™</button>
            <span class="muted small" id="status">ì´ˆê¸°í™” ì¤‘...</span>
        </div>
    </div>



  <hr />

  <div class="row" style="justify-content: space-between;">
    <h2 style="margin:0;">ê¸€ ëª©ë¡</h2>
    <div class="row"></div>
        <button id="btnNewPost" disabled>ê¸€ ì‘ì„±í•˜ê¸°</button>
        <button id="btnRefresh" disabled>ìƒˆë¡œê³ ì¹¨</button>
  </div>
  <div id="postList" class="muted" style="margin-top:10px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <div class="row" id="pager" style="justify-content: space-between; margin-top:12px;">
    <button id="btnPrev" disabled>ì´ì „</button>
    <div class="muted small">í˜ì´ì§€ <b id="pageNo">1</b></div>
    <button id="btnNext" disabled>ë‹¤ìŒ</button>
  </div>


  <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <div id="modalBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); padding:24px; overflow:auto;">
    <div style="max-width:860px; margin:40px auto; background:#fff; border-radius:16px; padding:16px; border:1px solid #eee;">
        <div class="row" style="justify-content: space-between; align-items:flex-start;">
        <div style="flex:1;">
            <div id="modalTitle" style="font-weight:800; font-size:20px; margin-bottom:6px;"></div>
            <div id="modalMeta" class="muted small"></div>
        </div>
        <div class="row">
            <button id="modalClose">ë‹«ê¸°</button>
        </div>
        </div>
        <hr />
        <div id="modalContent" style="white-space:pre-wrap; line-height:1.55;"></div>

        <hr />

        <h3 style="margin:0 0 10px;">ëŒ“ê¸€</h3>

        <div class="row" style="gap:8px;">
            <input id="commentInput" placeholder="ëŒ“ê¸€ (1~1000ì)" maxlength="1000" />
            <button id="btnComment">ë“±ë¡</button>
        </div>

        <div id="commentList" class="muted" style="margin-top:10px;">ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>


    </div>
    </div>


    
    <!-- ê¸€ ì‘ì„± ëª¨ë‹¬ -->
    <div id="writeBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); padding:24px; overflow:auto;">
        <div style="max-width:860px; margin:40px auto; background:#fff; border-radius:16px; padding:16px; border:1px solid #eee;">
            <div class="row" style="justify-content: space-between; align-items:flex-start;">
                <div style="font-weight:800; font-size:20px;">ìƒˆ ê¸€ ì‘ì„±</div>
                <button id="writeClose">ë‹«ê¸°</button>
            </div>
            <hr />

            <input id="title" placeholder="ì œëª©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." maxlength="80" />
            <div style="height:10px;"></div>
            <textarea id="content" placeholder="ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. 
ì˜ˆì‹œ]
24213ì´ë©´ ì–´ë””ê°€ë‚˜ìš”? 
ìˆ˜í•™ 3ë“±ê¸‰ ì»¤ë¦¬ ì¶”ì²œí•´ì£¼ì„¸ìš”. 
33333 ì¸ì„œìš¸ ê°€ëŠ¥?
êµ­ì–´ 2ë“±ê¸‰ì¸ë° ê°•ë¯¼ì² orìœ ëŒ€ì¢… ì¶”ì²œí•´ì£¼ì„¸ìš”
ì¼ë°˜ê³  ë‚´ì‹  3.4ì¸ë° ì •ì‹œë¡œ ëŒë¦´ê¹Œìš”?
ë¬¸ì œì§‘ ì¶”ì²œí•´ì£¼ì„¸ìš”" maxlength="5000"></textarea>

            <div class="row" style="justify-content:flex-end; margin-top:10px;">
                <button id="btnWrite" disabled>ì‘ì„±</button>
            </div>

            <div class="muted small" style="margin-top:8px;">
                â€» ì‘ì„±ì€ ìµëª…(ë‹‰ë„¤ì„)ìœ¼ë¡œ ì˜¬ë¼ê°€ë©°, ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”.
            </div>
        </div>
    </div>


  <script type="module">
    // ===== 1) Firebase SDK import (ëª¨ë“ˆ ë°©ì‹) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc,
      collection, addDoc,
      query, where, orderBy, limit, getDocs, startAfter,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== 2) ë„ˆì˜ Firebase ì„¤ì •ê°’ ë„£ê¸° =====
    // Firebase Console > Project settings > General > Your apps (Web) > SDK setup and configuration
    const firebaseConfig = {
      apiKey: "AIzaSyByA67hdXTuPjSkNISijCMu9BAqd2LPDmU",
      authDomain: "mgmcommunity-19ac2.firebaseapp.com",
      projectId: "mgmcommunity-19ac2",
      storageBucket: "mgmcommunity-19ac2.firebasestorage.app",
      messagingSenderId: "556812418434",
      appId: "1:556812418434:web:7c46c05b546b9c2f5aa39b",
    };

    // ===== 3) ì•± ì´ˆê¸°í™” =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== 4) DOM =====
    const $nickname = document.getElementById("nickname");
    const $status = document.getElementById("status");
    const $btnChangeNick = document.getElementById("btnChangeNick");
    const $title = document.getElementById("title");
    const $content = document.getElementById("content");
    const $btnWrite = document.getElementById("btnWrite");
    const $btnRefresh = document.getElementById("btnRefresh");
    const $postList = document.getElementById("postList");

    const $modalBackdrop = document.getElementById("modalBackdrop");
    const $modalClose = document.getElementById("modalClose");
    const $modalTitle = document.getElementById("modalTitle");
    const $modalMeta = document.getElementById("modalMeta");
    const $modalContent = document.getElementById("modalContent");


    const $commentInput = document.getElementById("commentInput");
    const $btnComment = document.getElementById("btnComment");
    const $commentList = document.getElementById("commentList");

    const $btnNewPost = document.getElementById("btnNewPost");
    const $writeBackdrop = document.getElementById("writeBackdrop");
    const $writeClose = document.getElementById("writeClose");

    const $btnTheme = document.getElementById("btnTheme");

    const $btnPrev = document.getElementById("btnPrev");
    const $btnNext = document.getElementById("btnNext");
    const $pageNo = document.getElementById("pageNo");



    let currentPostId = null; // ì§€ê¸ˆ ëª¨ë‹¬ë¡œ ë³´ê³  ìˆëŠ” ê¸€ id



    let currentUid = null;
    let currentNickname = null;

    const PAGE_SIZE = 5;
    let pageIndex = 1;

    // ì»¤ì„œ ìŠ¤íƒ: ê° í˜ì´ì§€ ì‹œì‘ì  ë¬¸ì„œ ìŠ¤ëƒ…ìƒ·ì„ ì €ì¥
    let pageCursors = []; // [ page2StartDoc, page3StartDoc, ... ]
    let currentStartAfterDoc = null;


    function makeDefaultNickname() {
      const n = Math.floor(1000 + Math.random() * 9000);
      return `ìµëª…${n}`;
    }

    function setStatus(msg) {
      $status.textContent = msg;
    }

    function escapeHtml(str) {
      return str
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function canWriteNow() {
      const t = $title.value.trim();
      const c = $content.value.trim();
      return !!currentUid && t.length >= 1 && t.length <= 80 && c.length >= 1 && c.length <= 5000;
    }

    function updateButtons() {
      const ready = !!currentUid;
      $btnRefresh.disabled = !ready;
      $btnNewPost.disabled = !ready;
      $btnWrite.disabled = !canWriteNow();
    }

    function openWriteModal() {
        $writeBackdrop.style.display = "block";
        $title.focus();
    }
    function closeWriteModal() {
        $writeBackdrop.style.display = "none";
        $title.value = "";
        $content.value = "";
        updateButtons();
    }

    $btnNewPost.addEventListener("click", openWriteModal);
    $writeClose.addEventListener("click", closeWriteModal);
    $writeBackdrop.addEventListener("click", (e) => {
        if (e.target === $writeBackdrop) closeWriteModal();
    });


    // ===== 5) ìµëª… ë¡œê·¸ì¸ + users/{uid} ìƒì„± =====
    async function bootstrap() {
      setStatus("ìµëª… ë¡œê·¸ì¸ ì¤‘...");
      await signInAnonymously(auth);

      onAuthStateChanged(auth, async (user) => {
        if (!user) return;

        currentUid = user.uid;
        setStatus("ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘...");

        // users/{uid} ë¬¸ì„œ í™•ì¸/ìƒì„±
        const userRef = doc(db, "users", currentUid);
        const snap = await getDoc(userRef);

        if (!snap.exists()) {
          const nick = makeDefaultNickname();
          await setDoc(userRef, {
            nickname: nick,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          });
          currentNickname = nick;
        } else {
          currentNickname = snap.data().nickname ?? makeDefaultNickname();
        }

        $nickname.textContent = currentNickname;
        setStatus("ì¤€ë¹„ ì™„ë£Œ");
        updateButtons();
        await loadPosts();
      });
    }

    // ===== 6) ë‹‰ë„¤ì„ ë³€ê²½ =====
    $btnChangeNick.addEventListener("click", async () => {
      if (!currentUid) return;

      const input = prompt("ìƒˆ ë‹‰ë„¤ì„ (2~12ì):", currentNickname ?? "");
      if (input == null) return;

      const newNick = input.trim();
      if (newNick.length < 2 || newNick.length > 12) {
        alert("ë‹‰ë„¤ì„ì€ 2~12ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      try {
        setStatus("ë‹‰ë„¤ì„ ë³€ê²½ ì¤‘...");
        await updateDoc(doc(db, "users", currentUid), {
          nickname: newNick,
          updatedAt: serverTimestamp(),
        });
        currentNickname = newNick;
        $nickname.textContent = currentNickname;
        setStatus("ì¤€ë¹„ ì™„ë£Œ");
      } catch (e) {
        console.error(e);
        alert("ë‹‰ë„¤ì„ ë³€ê²½ ì‹¤íŒ¨. (Rules/ê¶Œí•œ í™•ì¸)");
        setStatus("ì˜¤ë¥˜");
      }
    });

    function applyTheme(theme) {
        if (theme === "dark") {
            document.body.classList.add("dark");
            $btnTheme.textContent = "â˜€ï¸ë¼ì´íŠ¸ëª¨ë“œ";
        } else {
            document.body.classList.remove("dark");
            $btnTheme.textContent = "ğŸŒ™ë‹¤í¬ëª¨ë“œ";
        }
    }

    function toggleTheme() {
        const isDark = document.body.classList.contains("dark");
        const next = isDark ? "light" : "dark";
        localStorage.setItem("theme", next);
        applyTheme(next);
    }

    $btnTheme.addEventListener("click", toggleTheme);



    // ===== 7) ê¸€ ì‘ì„± =====
    async function createPost() {
      const title = $title.value.trim();
      const content = $content.value.trim();
      

      if (!canWriteNow()) return;

      try {
        setStatus("ê¸€ ì‘ì„± ì¤‘...");
        $btnWrite.disabled = true;

        // ë‹‰ë„¤ì„ ìµœì‹ ê°’ì„ usersì—ì„œ ë‹¤ì‹œ ì½ì–´ ìŠ¤ëƒ…ìƒ· ì €ì¥(ê¶Œì¥)
        const u = await getDoc(doc(db, "users", currentUid));
        const nick = u.data()?.nickname ?? currentNickname ?? "ìµëª…????";

        await addDoc(collection(db, "posts"), {
          title,
          content,
          authorUid: currentUid,
          authorNickname: nick,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          isDeleted: false,
          isBlind: false,
          blindReason: "",
        });

        $title.value = "";
        $content.value = "";
        setStatus("ì‘ì„± ì™„ë£Œ");
        await loadPosts();
        closeWriteModal();

      } catch (e) {
        console.error(e);
        alert("ì‘ì„± ì‹¤íŒ¨. (Rules/ì¸ë±ìŠ¤/ë„¤íŠ¸ì›Œí¬ í™•ì¸)");
        setStatus("ì˜¤ë¥˜");
      } finally {
        setStatus("ì¤€ë¹„ ì™„ë£Œ");
        updateButtons();
      }
    }


    $btnWrite.addEventListener("click", createPost);
    $title.addEventListener("input", updateButtons);
    $content.addEventListener("input", updateButtons);



    async function softDeletePost(postId) {
        if (!currentUid) return;

        const ok = confirm("ì´ ê¸€ì„ ì‚­ì œí• ê¹Œ? (ì‚­ì œí•˜ë©´ ëª©ë¡ì—ì„œ ì‚¬ë¼ì ¸)");
        if (!ok) return;

        try {
            setStatus("ì‚­ì œ ì¤‘...");
            await updateDoc(doc(db, "posts", postId), {
                isDeleted: true,
                updatedAt: serverTimestamp(),
            });
            setStatus("ì‚­ì œ ì™„ë£Œ");
            await loadPosts();
          } catch (e) {
            console.error(e);
            alert("ì‚­ì œ ì‹¤íŒ¨. (ì‘ì„±ìë§Œ ì‚­ì œ ê°€ëŠ¥ / Rules í™•ì¸)");
            setStatus("ì˜¤ë¥˜");
          } finally {
            setStatus("ì¤€ë¹„ ì™„ë£Œ");
          }
        }


    function openModal() {
        $modalBackdrop.style.display = "block";
    }
    function closeModal() {
        $modalBackdrop.style.display = "none";
        $modalTitle.textContent = "";
        $modalMeta.textContent = "";
        $modalContent.textContent = "";
        currentPostId = null;
        $commentInput.value = "";
        $commentList.textContent = "";
        $btnComment.disabled = false;

    }

    $modalClose.addEventListener("click", closeModal);
    $modalBackdrop.addEventListener("click", (e) => {
        if (e.target === $modalBackdrop) closeModal(); // ë°”ê¹¥ í´ë¦­ ë‹«ê¸°
    });

    async function openPostDetail(postId) {
    try {
        setStatus("ìƒì„¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
        const ref = doc(db, "posts", postId);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
            alert("ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì‚­ì œëœ ê¸€ì…ë‹ˆë‹¤.");
            setStatus("ì¤€ë¹„ ì™„ë£Œ");
            return;
        }

        const p = snap.data();

        // í˜¹ì‹œ ëª¨ë¥¼ ë°©ì–´(ì¼ë°˜ ìœ ì €ëŠ” rulesë¡œ ëª» ë³´ê²Œ ë˜ì§€ë§Œ)
        if (p.isDeleted || p.isBlind) {
            alert("ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì‚­ì œëœ ê¸€ì…ë‹ˆë‹¤.");
            setStatus("ì¤€ë¹„ ì™„ë£Œ");
            return;
        }

        $modalTitle.textContent = p.title ?? "(ì œëª© ì—†ìŒ)";
        const createdAt = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : "";
        $modalMeta.textContent = `${p.authorNickname ?? "ìµëª…"} Â· ${createdAt}`;
        $modalContent.textContent = p.content ?? "";

        currentPostId = postId;
        openModal();
        await loadComments(postId);

        setStatus("ì¤€ë¹„ ì™„ë£Œ");
    } catch (e) {
        console.error(e);
        alert("ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨");
        setStatus("ì˜¤ë¥˜");
    } finally {
      setStatus("ì¤€ë¹„ ì™„ë£Œ");
    }
    }



    function commentColRef(postId) {
        return collection(db, "posts", postId, "comments");
    }

    async function loadComments(postId) {
      try {
        $commentList.textContent = "ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        const q = query(
            commentColRef(postId),
            where("isDeleted", "==", false),
            where("isBlind", "==", false),
            orderBy("createdAt", "asc"),
            limit(100)
        );

        const snap = await getDocs(q);

        if (snap.empty) {
            $commentList.innerHTML = `<div class="muted">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
        }

        const html = snap.docs.map(d => {
            const c = d.data();
            const nick = escapeHtml(c.authorNickname ?? "ìµëª…");
            const content = escapeHtml(c.content ?? "");
            const createdAt = c.createdAt?.toDate ? c.createdAt.toDate().toLocaleString() : "";
            const isMine = (c.authorUid === currentUid);

            return `
                <div class="card commentCard" data-id="${d.id}" style="padding:10px; margin:10px 0;">
                    <div class="row" style="justify-content: space-between; align-items:flex-start;">
                        <div style="flex:1;">
                            <div class="muted small">${nick} Â· ${createdAt}</div>
                            <div style="margin-top:6px; white-space:pre-wrap;">${content}</div>
                        </div>
                        ${isMine ? `<button class="btnDeleteComment" data-id="${d.id}">ì‚­ì œ</button>` : ``}
                    </div>
                </div>
            `;
        }).join("");

        $commentList.innerHTML = html;
    } catch (e) {
        console.error(e);
        $commentList.innerHTML = `<div class="muted">ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨ (Rules/ì¸ë±ìŠ¤ í™•ì¸)</div>`;
    }
    }

    async function addComment() {
    if (!currentUid || !currentPostId) return;

    const content = $commentInput.value.trim();
        if (content.length < 1 || content.length > 1000) {
            alert("ëŒ“ê¸€ì€ 1~1000ì");
            return;
        }

    try {
        setStatus("ëŒ“ê¸€ ì‘ì„± ì¤‘...");
        $btnComment.disabled = true;

        // ìµœì‹  ë‹‰ë„¤ì„ ìŠ¤ëƒ…ìƒ·
        const u = await getDoc(doc(db, "users", currentUid));
        const nick = u.data()?.nickname ?? currentNickname ?? "ìµëª…????";

        await addDoc(commentColRef(currentPostId), {
            content,
            authorUid: currentUid,
            authorNickname: nick,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            isDeleted: false,
            isBlind: false,
        });

        $commentInput.value = "";
        await loadComments(currentPostId);
      } catch (e) {
        console.error(e);
        alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨ (Rules/ì¸ë±ìŠ¤/ë„¤íŠ¸ì›Œí¬ í™•ì¸)");
      } finally {
        $btnComment.disabled = false;
        setStatus("ì¤€ë¹„ ì™„ë£Œ");
      }
    }

    async function softDeleteComment(commentId) {
    if (!currentUid || !currentPostId) return;

    const ok = confirm("ì´ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œ?");
        if (!ok) return;

        try {
            setStatus("ëŒ“ê¸€ ì‚­ì œ ì¤‘...");
            await updateDoc(doc(db, "posts", currentPostId, "comments", commentId), {
                isDeleted: true,
                updatedAt: serverTimestamp(),
            });
            await loadComments(currentPostId);
        } catch (e) {
            console.error(e);
            alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨ (ì‘ì„±ìë§Œ ì‚­ì œ ê°€ëŠ¥ / Rules í™•ì¸)");
        } finally {
            setStatus("ì¤€ë¹„ ì™„ë£Œ");
        }
    }







    // ===== 8) ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° =====
    async function loadPosts() {
        if (!currentUid) return;

        try {
            setStatus("ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
            $postList.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

            const base = [
                collection(db, "posts"),
                where("isDeleted", "==", false),
                where("isBlind", "==", false),
                orderBy("createdAt", "desc"),
                limit(PAGE_SIZE),
            ];

            // startAfterê°€ ìˆìœ¼ë©´ ë‹¤ìŒ í˜ì´ì§€
            const q = currentStartAfterDoc
                ? query(...base, startAfter(currentStartAfterDoc))
                : query(...base);

            const snap = await getDocs(q);

            // UI: ì´ì „ ë²„íŠ¼ì€ 1í˜ì´ì§€ë©´ ë¹„í™œì„±
            $btnPrev.disabled = (pageIndex <= 1);

            if (snap.empty) {
                $postList.innerHTML = `<div class="muted">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                $btnNext.disabled = true;
                $pageNo.textContent = String(pageIndex);
                setStatus("ì¤€ë¹„ ì™„ë£Œ");
                return;
            }

            // ë‹¤ìŒ ë²„íŠ¼: PAGE_SIZEë§Œí¼ ê½‰ ì°¼ì„ ë•Œë§Œ "ë‹¤ìŒ ê°€ëŠ¥"ìœ¼ë¡œ ë³´ì(ê°„ë‹¨ íŒì •)
            $btnNext.disabled = snap.size < PAGE_SIZE;

            // HTML ë Œë”
            const html = snap.docs.map(d => {
                const p = d.data();
                const title = escapeHtml(p.title ?? "(ì œëª© ì—†ìŒ)");
                const nick = escapeHtml(p.authorNickname ?? "ìµëª…");
                const content = escapeHtml((p.content ?? "").slice(0, 120));
                const createdAt = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : "";
                const isMine = (p.authorUid === currentUid);

                return `
                    <div class="card postCard" data-id="${d.id}" style="cursor:pointer;">
                        <div class="row" style="justify-content: space-between; align-items: flex-start;">
                            <div style="flex:1;">
                                <div class="post-title">${title}</div>
                                <div class="muted small">${nick} Â· ${createdAt}</div>
                            </div>
                            ${isMine ? `<button class="btnDelete" data-id="${d.id}">ì‚­ì œ</button>` : ``}
                        </div>
                        <div style="margin-top:10px;">
                            ${content}${(p.content?.length ?? 0) > 120 ? "â€¦" : ""}
                        </div>
                    </div>
                `;
                }).join("");

                $postList.innerHTML = html;
                $pageNo.textContent = String(pageIndex);

                // ë‹¤ìŒ í˜ì´ì§€ë¡œ ê°ˆ ë•Œ ì“¸ "í˜„ì¬ í˜ì´ì§€ì˜ ë§ˆì§€ë§‰ ë¬¸ì„œ"
                // (ë‹¤ìŒ ëˆŒë €ì„ ë•Œ startAfterë¡œ ì‚¬ìš©)
                window.__lastDocForPaging = snap.docs[snap.docs.length - 1];

                setStatus("       ");
              } catch (e) {
                console.error(e);
                $postList.innerHTML = `<div class="muted">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨. (Rules/ì¸ë±ìŠ¤ í™•ì¸)</div>`;
                setStatus("ì˜¤ë¥˜");
            }
    }


    // âœ… ê¸€ ëª©ë¡ ì´ë²¤íŠ¸ ìœ„ì„ (í•œ ë²ˆë§Œ)
    $postList.addEventListener("click", (e) => {
        const del = e.target.closest(".btnDelete");
        if (del) {
            e.stopPropagation();
            softDeletePost(del.dataset.id);
            return;
        }
        const card = e.target.closest(".postCard");
        if (card) openPostDetail(card.dataset.id);
    });


    // âœ… ëŒ“ê¸€ ì´ë²¤íŠ¸: í•œ ë²ˆë§Œ ë“±ë¡ (loadPosts ë°–!)
    $btnComment.addEventListener("click", addComment);
    $commentInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") addComment();
    });

    $commentList.addEventListener("click", (e) => {
        const btn = e.target.closest(".btnDeleteComment");
        if (btn) {
            softDeleteComment(btn.dataset.id);
        }
    });


    $btnRefresh.addEventListener("click", async () => {
        pageIndex = 1;
        pageCursors = [];
        currentStartAfterDoc = null;
        await loadPosts();
    });


    $btnNext.addEventListener("click", async () => {
        const last = window.__lastDocForPaging;
        if (!last) return;

        // ë‹¤ìŒ í˜ì´ì§€ ì‹œì‘ì ìœ¼ë¡œ ì»¤ì„œ ì €ì¥
        pageCursors.push(currentStartAfterDoc); // í˜„ì¬ startAfterë¥¼ ì €ì¥í•´ë‘ë©´ prev êµ¬í˜„ì´ ì‰¬ì›€
        currentStartAfterDoc = last;
        pageIndex += 1;
        await loadPosts();
    });

    $btnPrev.addEventListener("click", async () => {
        if (pageIndex <= 1) return;

        // ì´ì „ í˜ì´ì§€ë¡œ ë˜ëŒë¦¬ê¸°
        currentStartAfterDoc = pageCursors.pop() ?? null;
        pageIndex = Math.max(1, pageIndex - 1);
        await loadPosts();
    });


    // ë‹¤í¬ëª¨ë“œ ì´ˆê¸° ì ìš©
    applyTheme(localStorage.getItem("theme") || "light");

    
    // ===== ì‹œì‘ =====
    bootstrap();
  </script>
</body>
</html>
